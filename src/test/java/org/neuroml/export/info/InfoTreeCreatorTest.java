package org.neuroml.export.info;

import java.io.IOException;

import javax.xml.bind.JAXBException;

import junit.framework.Assert;
import junit.framework.TestCase;

import org.lemsml.export.base.GenerationException;
import org.lemsml.jlems.core.expression.ParseError;
import org.lemsml.jlems.core.run.ConnectionError;
import org.lemsml.jlems.core.run.RuntimeError;
import org.lemsml.jlems.core.sim.ContentError;
import org.lemsml.jlems.core.sim.ParseException;
import org.lemsml.jlems.core.type.BuildException;
import org.lemsml.jlems.core.xml.XMLException;
import org.lemsml.jlems.io.util.JUtil;
import org.neuroml.export.Main;
import org.neuroml.export.info.model.InfoNode;
import org.neuroml.model.NeuroMLDocument;
import org.neuroml.model.util.NeuroMLConverter;

/**
 * @author matteocantarelli
 *
 */
public class InfoTreeCreatorTest extends TestCase
{

	public void testAbstract() throws ContentError, ParseError, ParseException, BuildException, XMLException, IOException, ConnectionError, RuntimeError, JAXBException, GenerationException
	{
		String expected="Element iafRef:\n" + 
				"	ID: iafRef\n" + 
				"Element adExBurst:\n" + 
				"	ID: adExBurst";
		Assert.assertEquals(expected, getInfoTreeAsString("NML2_AbstractCells.nml"));
	}

	public void testCell() throws ContentError, ParseError, ParseException, BuildException, XMLException, IOException, ConnectionError, RuntimeError, JAXBException, GenerationException
	{
		String expected="Cell SpikingCell:\n" + 
				"	ID: SpikingCell\n" + 
				"	Description: A Simple Spiking cell for testing purposes\n" + 
				"	Number of segments: 4";
		Assert.assertEquals(expected, getInfoTreeAsString("NML2_FullCell.nml"));
	}

	public void testIonChannel() throws ContentError, ParseError, ParseException, BuildException, XMLException, IOException, ConnectionError, RuntimeError, JAXBException, GenerationException
	{
		String expected="Ion Channel na:\n" + 
				"	ID: na\n" + 
				"	Gates:\n" + 
				"		gate m:\n" + 
				"			instances: 3\n" + 
				"			forward rate: 1000.00 * (v - -0.0400000)/0.0100000 / ( 1 - exp(-(v - -0.0400000) / 0.0100000))\n" + 
				"			reverse rate: 4000.00 * exp((v - -0.0650000)/-0.0180000)\n" + 
				"			forward rate plot: PlotNode [Title=RatePlot, X=mV, Y=ms-1, Data=-8.0000 3335.9820-7.9000 3344.9925-7.8000 3354.0096-7.7000 3363.0332-7.6000 3372.0631-7.5000 3381.0994-7.4000 3390.1421-7.3000 3399.1911-7.2000 3408.2463-7.1000 3417.3078-7.0000 3426.3756-6.9000 3435.4494-6.8000 3444.5295-6.7000 3453.6156-6.6000 3462.7078-6.5000 3471.8061-6.4000 3480.9103-6.3000 3490.0205-6.2000 3499.1367-6.1000 3508.2587-6.0000 3517.3867-5.9000 3526.5204-5.8000 3535.6600-5.7000 3544.8054-5.6000 3553.9565-5.5000 3563.1133-5.4000 3572.2758-5.3000 3581.4439-5.2000 3590.6176-5.1000 3599.7969-5.0000 3608.9818-4.9000 3618.1722-4.8000 3627.3680-4.7000 3636.5693-4.6000 3645.7761-4.5000 3654.9882-4.4000 3664.2057-4.3000 3673.4285-4.2000 3682.6566-4.1000 3691.8900-4.0000 3701.1286-3.9000 3710.3724-3.8000 3719.6214-3.7000 3728.8755-3.6000 3738.1348-3.5000 3747.3991-3.4000 3756.6685-3.3000 3765.9429-3.2000 3775.2223-3.1000 3784.5067-3.0000 3793.7960-2.9000 3803.0902-2.8000 3812.3893-2.7000 3821.6932-2.6000 3831.0020-2.5000 3840.3156-2.4000 3849.6339-2.3000 3858.9569-2.2000 3868.2847-2.1000 3877.6171-2.0000 3886.9542-1.9000 3896.2959-1.8000 3905.6421-1.7000 3914.9930-1.6000 3924.3484-1.5000 3933.7083-1.4000 3943.0726-1.3000 3952.4415-1.2000 3961.8147-1.1000 3971.1924-1.0000 3980.5744-0.9000 3989.9608-0.8000 3999.3515-0.7000 4008.7465-0.6000 4018.1458-0.5000 4027.5493-0.4000 4036.9570-0.3000 4046.3689-0.2000 4055.7849-0.1000 4065.20510.0000 4074.62940.1000 4084.05780.2000 4093.49030.3000 4102.92680.4000 4112.36730.5000 4121.81180.6000 4131.26020.7000 4140.71260.8000 4150.16880.9000 4159.62901.0000 4169.09301.1000 4178.56091.2000 4188.03261.3000 4197.50801.4000 4206.98721.5000 4216.47021.6000 4225.95691.7000 4235.44721.8000 4244.94131.9000 4254.43902.0000 4263.94032.1000 4273.44512.2000 4282.95362.3000 4292.46562.4000 4301.98122.5000 4311.50032.6000 4321.02282.7000 4330.54882.8000 4340.07822.9000 4349.61113.0000 4359.14743.1000 4368.68703.2000 4378.23003.3000 4387.77633.4000 4397.32593.5000 4406.87883.6000 4416.43493.7000 4425.99433.8000 4435.55703.9000 4445.12284.0000 4454.69184.1000 4464.26394.2000 4473.83924.3000 4483.41764.4000 4492.99924.5000 4502.58374.6000 4512.17144.7000 4521.76214.8000 4531.35574.9000 4540.95245.0000 4550.55215.1000 4560.15475.2000 4569.76025.3000 4579.36875.4000 4588.98015.5000 4598.59435.6000 4608.21145.7000 4617.83135.8000 4627.45415.9000 4637.07966.0000 4646.70806.1000 4656.33916.2000 4665.97296.3000 4675.60956.4000 4685.24876.5000 4694.89076.6000 4704.53536.7000 4714.18266.8000 4723.83256.9000 4733.48517.0000 4743.14027.1000 4752.79797.2000 4762.45827.3000 4772.12107.4000 4781.78647.5000 4791.45427.6000 4801.12467.7000 4810.79747.8000 4820.47277.9000 4830.15048.0000 4839.83068.1000 4849.51328.2000 4859.19818.3000 4868.88558.4000 4878.57528.5000 4888.26728.6000 4897.96168.7000 4907.65838.8000 4917.35738.9000 4927.05859.0000 4936.76209.1000 4946.46789.2000 4956.17589.3000 4965.88609.4000 4975.59849.5000 4985.31309.6000 4995.02989.7000 5004.74879.8000 5014.46989.9000 5024.1930]\n" + 
				"			reverse rate plot: PlotNode [Title=RatePlot, X=mV, Y=ms-1, Data=-8.0000 168.5754-7.9000 167.6414-7.8000 166.7127-7.7000 165.7891-7.6000 164.8706-7.5000 163.9572-7.4000 163.0488-7.3000 162.1455-7.2000 161.2472-7.1000 160.3539-7.0000 159.4655-6.9000 158.5820-6.8000 157.7034-6.7000 156.8297-6.6000 155.9609-6.5000 155.0968-6.4000 154.2376-6.3000 153.3831-6.2000 152.5333-6.1000 151.6882-6.0000 150.8479-5.9000 150.0122-5.8000 149.1811-5.7000 148.3546-5.6000 147.5327-5.5000 146.7153-5.4000 145.9025-5.3000 145.0942-5.2000 144.2903-5.1000 143.4909-5.0000 142.6960-4.9000 141.9054-4.8000 141.1192-4.7000 140.3374-4.6000 139.5599-4.5000 138.7867-4.4000 138.0178-4.3000 137.2532-4.2000 136.4928-4.1000 135.7366-4.0000 134.9846-3.9000 134.2368-3.8000 133.4931-3.7000 132.7535-3.6000 132.0180-3.5000 131.2866-3.4000 130.5593-3.3000 129.8360-3.2000 129.1167-3.1000 128.4013-3.0000 127.6900-2.9000 126.9825-2.8000 126.2790-2.7000 125.5794-2.6000 124.8837-2.5000 124.1918-2.4000 123.5038-2.3000 122.8196-2.2000 122.1391-2.1000 121.4625-2.0000 120.7895-1.9000 120.1203-1.8000 119.4549-1.7000 118.7931-1.6000 118.1349-1.5000 117.4804-1.4000 116.8296-1.3000 116.1823-1.2000 115.5387-1.1000 114.8986-1.0000 114.2620-0.9000 113.6290-0.8000 112.9995-0.7000 112.3734-0.6000 111.7509-0.5000 111.1317-0.4000 110.5160-0.3000 109.9038-0.2000 109.2949-0.1000 108.68940.0000 108.08720.1000 107.48840.2000 106.89290.3000 106.30070.4000 105.71180.5000 105.12610.6000 104.54370.7000 103.96450.8000 103.38850.9000 102.81571.0000 102.24611.1000 101.67971.2000 101.11641.3000 100.55621.4000 99.99911.5000 99.44501.6000 98.89411.7000 98.34621.8000 97.80141.9000 97.25952.0000 96.72072.1000 96.18482.2000 95.65202.3000 95.12202.4000 94.59512.5000 94.07102.6000 93.54982.7000 93.03152.8000 92.51612.9000 92.00363.0000 91.49393.1000 90.98703.2000 90.48293.3000 89.98163.4000 89.48313.5000 88.98733.6000 88.49433.7000 88.00413.8000 87.51653.9000 87.03164.0000 86.54954.1000 86.07004.2000 85.59314.3000 85.11894.4000 84.64744.5000 84.17844.6000 83.71214.7000 83.24834.8000 82.78714.9000 82.32845.0000 81.87235.1000 81.41875.2000 80.96765.3000 80.51915.4000 80.07305.5000 79.62945.6000 79.18825.7000 78.74955.8000 78.31325.9000 77.87936.0000 77.44796.1000 77.01886.2000 76.59216.3000 76.16786.4000 75.74586.5000 75.32626.6000 74.90886.7000 74.49386.8000 74.08116.9000 73.67077.0000 73.26267.1000 72.85677.2000 72.45307.3000 72.05167.4000 71.65257.5000 71.25557.6000 70.86077.7000 70.46817.8000 70.07777.9000 69.68958.0000 69.30348.1000 68.91958.2000 68.53768.3000 68.15798.4000 67.78038.5000 67.40488.6000 67.03148.7000 66.66008.8000 66.29078.9000 65.92349.0000 65.55829.1000 65.19509.2000 64.83389.3000 64.47469.4000 64.11749.5000 63.76229.6000 63.40909.7000 63.05779.8000 62.70839.9000 62.3609]\n" + 
				"		gate h:\n" + 
				"			instances: 1\n" + 
				"			forward rate: 70.0000 * exp((v - -0.0650000)/-0.0200000)\n" + 
				"			reverse rate: 1000.00 /(1 + exp((v - -0.0350000)/0.0100000))\n" + 
				"			forward rate plot: PlotNode [Title=RatePlot, X=mV, Y=ms-1, Data=-8.0000 4.0491-7.9000 4.0289-7.8000 4.0088-7.7000 3.9888-7.6000 3.9689-7.5000 3.9491-7.4000 3.9294-7.3000 3.9098-7.2000 3.8903-7.1000 3.8709-7.0000 3.8516-6.9000 3.8324-6.8000 3.8133-6.7000 3.7943-6.6000 3.7754-6.5000 3.7565-6.4000 3.7378-6.3000 3.7192-6.2000 3.7006-6.1000 3.6821-6.0000 3.6638-5.9000 3.6455-5.8000 3.6273-5.7000 3.6092-5.6000 3.5912-5.5000 3.5733-5.4000 3.5555-5.3000 3.5378-5.2000 3.5201-5.1000 3.5026-5.0000 3.4851-4.9000 3.4677-4.8000 3.4504-4.7000 3.4332-4.6000 3.4161-4.5000 3.3990-4.4000 3.3821-4.3000 3.3652-4.2000 3.3484-4.1000 3.3317-4.0000 3.3151-3.9000 3.2986-3.8000 3.2821-3.7000 3.2658-3.6000 3.2495-3.5000 3.2333-3.4000 3.2171-3.3000 3.2011-3.2000 3.1851-3.1000 3.1693-3.0000 3.1534-2.9000 3.1377-2.8000 3.1221-2.7000 3.1065-2.6000 3.0910-2.5000 3.0756-2.4000 3.0602-2.3000 3.0450-2.2000 3.0298-2.1000 3.0147-2.0000 2.9996-1.9000 2.9847-1.8000 2.9698-1.7000 2.9550-1.6000 2.9403-1.5000 2.9256-1.4000 2.9110-1.3000 2.8965-1.2000 2.8820-1.1000 2.8677-1.0000 2.8534-0.9000 2.8391-0.8000 2.8250-0.7000 2.8109-0.6000 2.7969-0.5000 2.7829-0.4000 2.7690-0.3000 2.7552-0.2000 2.7415-0.1000 2.72780.0000 2.71420.1000 2.70070.2000 2.68720.3000 2.67380.4000 2.66050.5000 2.64720.6000 2.63400.7000 2.62080.8000 2.60780.9000 2.59481.0000 2.58181.1000 2.56891.2000 2.55611.3000 2.54341.4000 2.53071.5000 2.51811.6000 2.50551.7000 2.49301.8000 2.48061.9000 2.46822.0000 2.45592.1000 2.44372.2000 2.43152.3000 2.41932.4000 2.40732.5000 2.39532.6000 2.38332.7000 2.37142.8000 2.35962.9000 2.34783.0000 2.33613.1000 2.32453.2000 2.31293.3000 2.30133.4000 2.28993.5000 2.27843.6000 2.26713.7000 2.25583.8000 2.24453.9000 2.23334.0000 2.22224.1000 2.21114.2000 2.20014.3000 2.18914.4000 2.17824.5000 2.16734.6000 2.15654.7000 2.14584.8000 2.13514.9000 2.12445.0000 2.11385.1000 2.10335.2000 2.09285.3000 2.08235.4000 2.07205.5000 2.06165.6000 2.05135.7000 2.04115.8000 2.03095.9000 2.02086.0000 2.01076.1000 2.00076.2000 1.99076.3000 1.98086.4000 1.97096.5000 1.96116.6000 1.95136.7000 1.94166.8000 1.93196.9000 1.92227.0000 1.91277.1000 1.90317.2000 1.89367.3000 1.88427.4000 1.87487.5000 1.86547.6000 1.85617.7000 1.84697.8000 1.83777.9000 1.82858.0000 1.81948.1000 1.81038.2000 1.80138.3000 1.79238.4000 1.78348.5000 1.77458.6000 1.76568.7000 1.75688.8000 1.74808.9000 1.73939.0000 1.73069.1000 1.72209.2000 1.71349.3000 1.70499.4000 1.69649.5000 1.68799.6000 1.67959.7000 1.67119.8000 1.66289.9000 1.6545]\n" + 
				"			reverse rate plot: PlotNode [Title=RatePlot, X=mV, Y=ms-1, Data=-8.0000 62.9734-7.9000 62.3858-7.8000 61.8035-7.7000 61.2262-7.6000 60.6539-7.5000 60.0866-7.4000 59.5244-7.3000 58.9670-7.2000 58.4146-7.1000 57.8670-7.0000 57.3242-6.9000 56.7862-6.8000 56.2529-6.7000 55.7244-6.6000 55.2005-6.5000 54.6813-6.4000 54.1667-6.3000 53.6566-6.2000 53.1511-6.1000 52.6501-6.0000 52.1536-5.9000 51.6614-5.8000 51.1737-5.7000 50.6903-5.6000 50.2113-5.5000 49.7365-5.4000 49.2660-5.3000 48.7997-5.2000 48.3376-5.1000 47.8797-5.0000 47.4259-4.9000 46.9761-4.8000 46.5305-4.7000 46.0888-4.6000 45.6512-4.5000 45.2175-4.4000 44.7877-4.3000 44.3618-4.2000 43.9398-4.1000 43.5216-4.0000 43.1073-3.9000 42.6966-3.8000 42.2898-3.7000 41.8866-3.6000 41.4871-3.5000 41.0913-3.4000 40.6991-3.3000 40.3104-3.2000 39.9253-3.1000 39.5438-3.0000 39.1657-2.9000 38.7911-2.8000 38.4200-2.7000 38.0522-2.6000 37.6879-2.5000 37.3269-2.4000 36.9692-2.3000 36.6148-2.2000 36.2637-2.1000 35.9158-2.0000 35.5712-1.9000 35.2297-1.8000 34.8914-1.7000 34.5562-1.6000 34.2242-1.5000 33.8952-1.4000 33.5692-1.3000 33.2463-1.2000 32.9264-1.1000 32.6095-1.0000 32.2955-0.9000 31.9844-0.8000 31.6762-0.7000 31.3709-0.6000 31.0685-0.5000 30.7689-0.4000 30.4720-0.3000 30.1780-0.2000 29.8867-0.1000 29.59810.0000 29.31220.1000 29.02900.2000 28.74850.3000 28.47060.4000 28.19530.5000 27.92260.6000 27.65240.7000 27.38480.8000 27.11970.9000 26.85711.0000 26.59701.1000 26.33931.2000 26.08411.3000 25.83121.4000 25.58081.5000 25.33271.6000 25.08701.7000 24.84351.8000 24.60241.9000 24.36362.0000 24.12702.1000 23.89272.2000 23.66062.3000 23.43072.4000 23.20292.5000 22.97742.6000 22.75392.7000 22.53262.8000 22.31342.9000 22.09633.0000 21.88133.1000 21.66833.2000 21.45733.3000 21.24833.4000 21.04133.5000 20.83633.6000 20.63333.7000 20.43223.8000 20.23303.9000 20.03574.0000 19.84034.1000 19.64684.2000 19.45514.3000 19.26524.4000 19.07724.5000 18.89104.6000 18.70654.7000 18.52384.8000 18.34294.9000 18.16375.0000 17.98625.1000 17.81045.2000 17.63635.3000 17.46395.4000 17.29325.5000 17.12405.6000 16.95655.7000 16.79065.8000 16.62645.9000 16.46366.0000 16.30256.1000 16.14296.2000 15.98486.3000 15.82836.4000 15.67336.5000 15.51986.6000 15.36776.7000 15.21716.8000 15.06806.9000 14.92037.0000 14.77407.1000 14.62927.2000 14.48577.3000 14.34377.4000 14.20307.5000 14.06367.6000 13.92567.7000 13.78907.8000 13.65377.9000 13.51968.0000 13.38698.1000 13.25558.2000 13.12538.3000 12.99648.4000 12.86888.5000 12.74238.6000 12.61728.7000 12.49328.8000 12.37048.9000 12.24889.0000 12.12849.1000 12.00929.2000 11.89119.3000 11.77429.4000 11.65849.5000 11.54389.6000 11.43029.7000 11.31789.8000 11.20649.9000 11.0961]";
				 

		Assert.assertEquals(expected, getInfoTreeAsString("NML2_SimpleIonChannel.nml"));
	}

	public void testNetwork() throws ContentError, ParseError, ParseException, BuildException, XMLException, IOException, ConnectionError, RuntimeError, JAXBException, GenerationException
	{
		String expected="Network InstanceBasedNetwork:\n" + 
				"	ID: InstanceBasedNetwork\n" + 
				"	Number of populations: 1\n" + 
				"	Population iafCells:\n" + 
				"		ID: iafCells\n" + 
				"		Size (number of instances): 3\n" + 
				"	Number of projections: 2\n" + 
				"	Projection internal1:\n" + 
				"		ID: internal1\n" + 
				"		Presynaptic population: iafCells\n" + 
				"		Postsynaptic population: iafCells\n" + 
				"	Projection internal2:\n" + 
				"		ID: internal2\n" + 
				"		Presynaptic population: iafCells\n" + 
				"		Postsynaptic population: iafCells";
		Assert.assertEquals(expected, getInfoTreeAsString("NML2_InstanceBasedNetwork.nml"));
	}
	
	/**
	 * Test method for {@link org.neuroml.export.info.InfoTreeCreator#createInfoTree(org.neuroml.model.NeuroMLDocument)}.
	 * @throws ContentError 
	 * @throws JAXBException 
	 */
	private String getInfoTreeAsString(String nmlFilename) throws ContentError, JAXBException
	{
		String content = JUtil.getRelativeResource(this.getClass(), Main.getNeuroMLExamplesResourcesDir()+"/"+nmlFilename);
		NeuroMLConverter nmlc = new NeuroMLConverter();
    	NeuroMLDocument nmlDocument = nmlc.loadNeuroML(content);
		InfoNode root = InfoTreeCreator.createInfoTree(nmlDocument);
		Assert.assertFalse(root.isEmpty());
		return root.toString();
	}

}
